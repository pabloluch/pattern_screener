<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wave Pattern Scanner Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --text-color: #2c3e50;
            --light-bg: #f5f6fa;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--text-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            background-color: white;
            box-shadow: var(--card-shadow);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .status-dot.connected {
            background-color: var(--success-color);
        }

        .status-dot.disconnected {
            background-color: var(--danger-color);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .stat-card {
            text-align: center;
            padding: 20px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
            color: var(--accent-color);
        }

        .stat-label {
            color: var(--secondary-color);
            font-size: 0.9em;
        }

        .chart-container {
            min-height: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .pattern-bull {
            color: var(--success-color);
            font-weight: bold;
        }

        .pattern-bear {
            color: var(--danger-color);
            font-weight: bold;
        }

        .pattern-details {
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 0.9em;
            max-height: 100px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
        }

        .timeframe-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--card-shadow);
        }

        .filter-button.active {
            background-color: var(--accent-color);
            color: white;
        }

        .last-scan {
            font-style: italic;
            color: var(--secondary-color);
            text-align: right;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Wave Pattern Scanner</h1>
            <div class="status-indicator">
                <div id="status-dot" class="status-dot"></div>
                <span id="status-text">Connecting...</span>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card stat-card">
                <div class="stat-value" id="total-patterns">0</div>
                <div class="stat-label">Total Patterns</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" id="bull-patterns">0</div>
                <div class="stat-label">Bull Patterns</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" id="bear-patterns">0</div>
                <div class="stat-label">Bear Patterns</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" id="active-pairs">0</div>
                <div class="stat-label">Active Pairs</div>
            </div>
        </div>

        <div class="card">
            <h2>Pattern Distribution</h2>
            <div class="timeframe-filter" id="timeframe-filter"></div>
            <div class="chart-container">
                <canvas id="patternChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>Recent Patterns</h2>
            <div class="last-scan" id="last-scan-time"></div>
            <table id="patterns-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Timeframe</th>
                        <th>Pattern</th>
                        <th>Wave Type</th>
                        <th>Max Position</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let patternChart;
        let lastUpdateTime = new Date();
        const websocketUrl = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`;
        let ws;

        function initializeWebSocket() {
            ws = new WebSocket(websocketUrl);
            
            ws.onopen = function() {
                document.getElementById('status-dot').className = 'status-dot connected';
                document.getElementById('status-text').textContent = 'Connected';
                console.log('WebSocket Connected');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                logPatternData(data.data); // Add debugging
                updateDashboard(data.data);
            };
            
            ws.onclose = function() {
                document.getElementById('status-dot').className = 'status-dot disconnected';
                document.getElementById('status-text').textContent = 'Disconnected';
                console.log('WebSocket Disconnected');
                setTimeout(initializeWebSocket, 5000); // Reconnect after 5 seconds
            };

            ws.onerror = function(error) {
                console.error('WebSocket Error:', error);
            };
        }

        function updateLastScanTime() {
            const element = document.getElementById('last-scan-time');
            function update() {
                const now = new Date();
                const diff = Math.floor((now - lastUpdateTime) / 1000);
                element.textContent = `Last scan: ${moment(lastUpdateTime).format('HH:mm:ss')} (${diff} seconds ago)`;
            }
            update();
            setInterval(update, 1000);
        }

        function updateDashboard(patterns) {
            // Update statistics
            const uniquePairs = new Set(patterns.map(p => p.symbol));
            document.getElementById('total-patterns').textContent = patterns.length;
            document.getElementById('bull-patterns').textContent = patterns.filter(p => p.pattern_type === 'bull').length;
            document.getElementById('bear-patterns').textContent = patterns.filter(p => p.pattern_type === 'bear').length;
            document.getElementById('active-pairs').textContent = uniquePairs.size;

            // Update table
            updatePatternsTable(patterns);

            // Update chart
            updatePatternChart(patterns);
        }

        function updatePatternsTable(patterns) {
        const tbody = document.getElementById('patterns-table').querySelector('tbody');
        tbody.innerHTML = patterns.map(p => `
            <tr>
                <td>${moment(p.timestamp).format('YYYY-MM-DD HH:mm:ss')}</td>
                <td>${p.symbol}</td>
                <td>${p.timeframe}</td>
                <td class="pattern-${p.pattern_type}">${p.pattern_type.toUpperCase()}</td>
                <td>${p.wave_type.replace('_', ' ')}</td>
                <td>${p.max_position ? p.max_position.toLocaleString() : 'N/A'}</td>
                <td class="pattern-details">${p.pattern_points || 'No details available'}</td>
            </tr>
        `).join('');
    }

    function updatePatternChart(patterns) {
        const timeframes = [...new Set(patterns.map(p => p.timeframe))];
        const data = timeframes.map(tf => {
            const tfPatterns = patterns.filter(p => p.timeframe === tf);
            return {
                timeframe: tf,
                bull: tfPatterns.filter(p => p.pattern_type === 'bull').length,
                bear: tfPatterns.filter(p => p.pattern_type === 'bear').length
            };
        });

        if (patternChart) {
            patternChart.destroy();
        }

        const ctx = document.getElementById('patternChart').getContext('2d');
        patternChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.timeframe),
                datasets: [{
                    label: 'Bull Patterns',
                    data: data.map(d => d.bull),
                    backgroundColor: 'rgba(46, 204, 113, 0.5)',
                    borderColor: 'rgb(46, 204, 113)',
                    borderWidth: 1
                }, {
                    label: 'Bear Patterns',
                    data: data.map(d => d.bear),
                    backgroundColor: 'rgba(231, 76, 60, 0.5)',
                    borderColor: 'rgb(231, 76, 60)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // Add debugging output
    function logPatternData(patterns) {
        console.log('Received patterns:', patterns);
        console.log('Pattern count:', patterns.length);
        if (patterns.length > 0) {
            console.log('Sample pattern:', patterns[0]);
        }
    }

        // Initialize
        async function initialize() {
            initializeWebSocket();
            
            // Fetch initial data
            try {
                const response = await fetch('/patterns');
                const patterns = await response.json();
                updateDashboard(patterns);
            } catch (error) {
                console.error('Error fetching initial data:', error);
            }
        }

        initialize();
    </script>
</body>
</html>