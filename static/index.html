<!DOCTYPE html>
<html>
<head>
    <title>Wave Pattern Scanner</title>
    <!-- Add Recharts dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.0/Recharts.js"></script>
    
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
        }

        .close {
            float: right;
            cursor: pointer;
            font-size: 24px;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px;
        }

        .graph-container {
            margin: 20px 0;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Wave Pattern Scanner</h1>
            <div class="status-indicator">
                <div id="status-dot" class="status-dot"></div>
                <span id="status-text">Connecting...</span>
            </div>
        </div>

        <div id="loading" class="loading">
            Loading wave data...
        </div>

        <div id="scan-history"></div>

        <div id="graphModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="graphTitle">Wave Pattern Analysis</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="graph-container"></div>
                    <div class="pattern-details">
                        <h3>Pattern Points</h3>
                        <div id="patternPoints"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Wave Pattern Graph Component
        const WavePatternGraph = ({ data }) => {
            const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;
            
            // Format data for Recharts
            const formattedData = data.timestamps.map((timestamp, index) => ({
                timestamp,
                fastWave: data.fast_wave[index],
                slowWave: data.slow_wave[index]
            })).reverse();

            return React.createElement(
                'div',
                { style: { width: '100%', height: '100%' } },
                React.createElement(
                    ResponsiveContainer,
                    null,
                    React.createElement(
                        LineChart,
                        {
                            data: formattedData,
                            margin: { top: 5, right: 30, left: 20, bottom: 5 }
                        },
                        React.createElement(CartesianGrid, { strokeDasharray: '3 3' }),
                        React.createElement(XAxis, {
                            dataKey: 'timestamp',
                            tickFormatter: (value) => {
                                const date = new Date(value);
                                return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                            }
                        }),
                        React.createElement(YAxis),
                        React.createElement(Tooltip, {
                            labelFormatter: (value) => new Date(value).toUTCString(),
                            formatter: (value) => value.toFixed(4)
                        }),
                        React.createElement(Legend),
                        React.createElement(Line, {
                            type: 'monotone',
                            dataKey: 'fastWave',
                            stroke: '#8884d8',
                            name: 'Fast Wave',
                            dot: false
                        }),
                        React.createElement(Line, {
                            type: 'monotone',
                            dataKey: 'slowWave',
                            stroke: '#82ca9d',
                            name: 'Slow Wave',
                            dot: false
                        })
                    )
                )
            );
        };

        // WebSocket connection
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const modal = document.getElementById('graphModal');
        const closeBtn = document.querySelector('.close');
        const graphContainer = document.querySelector('.graph-container');
        let currentSymbol = null;
        let currentTimeframe = null;

        ws.onopen = () => {
            statusDot.style.backgroundColor = '#4CAF50';
            statusText.textContent = 'Connected';
        };

        ws.onclose = () => {
            statusDot.style.backgroundColor = '#ccc';
            statusText.textContent = 'Disconnected';
        };

        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'scan_update') {
                updateScanHistory(data.data);
            }
        };

        function updateScanHistory(patterns) {
            const historyDiv = document.getElementById('scan-history');
            historyDiv.innerHTML = patterns.map(pattern => {
                const timestamp = new Date(pattern.timestamp).toLocaleString();
                return `
                    <div class="pattern" onclick="showGraph('${pattern.symbol}', '${pattern.timeframe}')">
                        <strong>${pattern.symbol}</strong> - ${pattern.timeframe} - ${pattern.pattern_type} 
                        ${pattern.wave_type} - ${timestamp}
                    </div>
                `;
            }).join('');
        }

        async function showGraph(symbol, timeframe) {
            currentSymbol = symbol;
            currentTimeframe = timeframe;
            document.getElementById('loading').style.display = 'block';
            modal.style.display = 'block';
            document.getElementById('graphTitle').textContent = 
                `Wave Pattern Analysis - ${symbol} ${timeframe}`;

            try {
                const response = await fetch(`/wave-data/${symbol}/${timeframe}`);
                const data = await response.json();
                
                // Render the graph
                const root = ReactDOM.createRoot(graphContainer);
                root.render(React.createElement(WavePatternGraph, { data: data }));
                
                // Update pattern points
                const patternPoints = document.getElementById('patternPoints');
                if (data.patterns) {
                    patternPoints.innerHTML = formatPatternPoints(data.patterns);
                }
            } catch (error) {
                console.error('Error fetching wave data:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function formatPatternPoints(patterns) {
            let html = '';
            ['bull', 'bear'].forEach(type => {
                ['fast_wave', 'slow_wave'].forEach(wave => {
                    if (patterns[type]?.[wave]?.pattern_points) {
                        html += `<h4>${type.toUpperCase()} ${wave.replace('_', ' ')}</h4>`;
                        html += `<pre>${patterns[type][wave].pattern_points}</pre>`;
                    }
                });
            });
            return html;
        }

        // Modal close button
        closeBtn.onclick = () => {
            modal.style.display = 'none';
        };

        // Close modal when clicking outside
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    </script>
</body>
</html>